<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Sprint KPI Dashboard</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="shared-dashboard-styles.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'telus-purple': '#4B0082',
                        'telus-green': '#66CC00',
                        'telus-blue': '#0066CC',
                        'telus-light-purple': '#8A2BE2',
                        'telus-dark-purple': '#2E0054',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // KPI calculation functions
        const calculateKPIs = (developer) => {
            const commits = developer.commits_in_sprint || 0;
            const assigned = developer.issues_assigned_in_sprint || 0;
            const closed = developer.issues_closed_in_sprint || 0;
            const storyPoints = developer.story_points_closed_in_sprint || 0;

            return {
                // Productivity KPI: Commits per sprint (target: 10+)
                productivity: commits,
                productivityScore: commits >= 15 ? 'excellent' : commits >= 10 ? 'good' : commits >= 5 ? 'fair' : 'needs-improvement',
                
                // Completion Rate KPI: % of assigned issues closed
                completionRate: assigned > 0 ? Math.round((closed / assigned) * 100) : 0,
                completionScore: assigned > 0 ? 
                    (closed / assigned >= 0.8 ? 'excellent' : 
                     closed / assigned >= 0.6 ? 'good' : 
                     closed / assigned >= 0.4 ? 'fair' : 'needs-improvement') : 'no-data',
                
                // Velocity KPI: Story points delivered
                velocity: storyPoints,
                velocityScore: storyPoints >= 10 ? 'excellent' : storyPoints >= 5 ? 'good' : storyPoints >= 2 ? 'fair' : storyPoints > 0 ? 'needs-improvement' : 'no-delivery',
                
                // Efficiency KPI: Story points per commit (quality indicator)
                efficiency: commits > 0 ? Math.round((storyPoints / commits) * 10) / 10 : 0,
                efficiencyScore: commits > 0 ? 
                    (storyPoints / commits >= 1 ? 'excellent' : 
                     storyPoints / commits >= 0.5 ? 'good' : 
                     storyPoints / commits >= 0.2 ? 'fair' : 'needs-improvement') : 'no-data'
            };
        };

        const getScoreColor = (score) => {
            switch(score) {
                case 'excellent': return 'text-green-600 bg-green-100';
                case 'good': return 'text-blue-600 bg-blue-100';
                case 'fair': return 'text-yellow-600 bg-yellow-100';
                case 'needs-improvement': return 'text-red-600 bg-red-100';
                case 'no-delivery': return 'text-gray-600 bg-gray-100';
                case 'no-data': return 'text-gray-400 bg-gray-50';
                default: return 'text-gray-600 bg-gray-100';
            }
        };

        const getScoreIcon = (score) => {
            switch(score) {
                case 'excellent': return 'ðŸŸ¢';
                case 'good': return 'ðŸ”µ';
                case 'fair': return 'ðŸŸ¡';
                case 'needs-improvement': return 'ðŸ”´';
                case 'no-delivery': return 'âšª';
                case 'no-data': return 'âš«';
                default: return 'âšª';
            }
        };

        const KPICard = ({ title, value, score, unit = '', description }) => (
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-4">
                <div className="flex items-center justify-between mb-2">
                    <h4 className="text-sm font-medium text-gray-700">{title}</h4>
                    <span className="text-lg">{getScoreIcon(score)}</span>
                </div>
                <div className="flex items-baseline space-x-2">
                    <span className="text-2xl font-bold text-gray-900">{value}</span>
                    {unit && <span className="text-sm text-gray-500">{unit}</span>}
                </div>
                <div className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium mt-2 ${getScoreColor(score)}`}>
                    {score.replace('-', ' ')}
                </div>
                <p className="text-xs text-gray-500 mt-2">{description}</p>
            </div>
        );

        const DeveloperKPIRow = ({ developer, sprintName }) => {
            const kpis = calculateKPIs(developer);
            
            return (
                <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-4">
                    <div className="flex items-center justify-between mb-4">
                        <div>
                            <h3 className="text-lg font-semibold text-gray-900">{developer.name}</h3>
                            <p className="text-sm text-gray-500">{developer.email}</p>
                        </div>
                        <div className="text-right">
                            <p className="text-sm font-medium text-gray-700">Sprint: {sprintName}</p>
                        </div>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <KPICard
                            title="Productivity"
                            value={kpis.productivity}
                            score={kpis.productivityScore}
                            unit="commits"
                            description="Number of commits made during sprint. Target: 10+ commits"
                        />
                        <KPICard
                            title="Completion Rate"
                            value={kpis.completionRate}
                            score={kpis.completionScore}
                            unit="%"
                            description="Percentage of assigned issues completed. Target: 80%+"
                        />
                        <KPICard
                            title="Velocity"
                            value={kpis.velocity}
                            score={kpis.velocityScore}
                            unit="points"
                            description="Story points delivered in sprint. Target: 5+ points"
                        />
                        <KPICard
                            title="Efficiency"
                            value={kpis.efficiency}
                            score={kpis.efficiencyScore}
                            unit="pts/commit"
                            description="Story points per commit ratio. Target: 0.5+ points per commit"
                        />
                    </div>
                </div>
            );
        };

        const SprintKPISection = ({ sprintKey, sprintData }) => {
            const developers = Object.values(sprintData.developers);
            const sprintInfo = sprintData.sprint_info;
            
            // Calculate sprint-level aggregates
            const totalCommits = developers.reduce((sum, dev) => sum + (dev.commits_in_sprint || 0), 0);
            const totalStoryPoints = developers.reduce((sum, dev) => sum + (dev.story_points_closed_in_sprint || 0), 0);
            const totalIssuesAssigned = developers.reduce((sum, dev) => sum + (dev.issues_assigned_in_sprint || 0), 0);
            const totalIssuesClosed = developers.reduce((sum, dev) => sum + (dev.issues_closed_in_sprint || 0), 0);
            
            const sprintCompletionRate = totalIssuesAssigned > 0 ? Math.round((totalIssuesClosed / totalIssuesAssigned) * 100) : 0;
            const avgCommitsPerDev = developers.length > 0 ? Math.round(totalCommits / developers.length) : 0;
            
            return (
                <div className="mb-8">
                    <div className="bg-gradient-to-r from-telus-purple to-telus-light-purple rounded-lg p-6 mb-6">
                        <div className="flex items-center justify-between text-white">
                            <div>
                                <h2 className="text-2xl font-bold">{sprintInfo.name}</h2>
                                <p className="text-telus-light-purple-100">
                                    {sprintInfo.state} â€¢ {new Date(sprintInfo.start_date).toLocaleDateString()} - {new Date(sprintInfo.end_date).toLocaleDateString()}
                                </p>
                            </div>
                            <div className="text-right">
                                <div className="text-3xl font-bold">{developers.length}</div>
                                <div className="text-sm">Active Developers</div>
                            </div>
                        </div>
                        
                        {/* Sprint Summary KPIs */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mt-6">
                            <div className="bg-white bg-opacity-20 rounded-lg p-4">
                                <div className="text-2xl font-bold text-white">{totalCommits}</div>
                                <div className="text-sm text-white opacity-90">Total Commits</div>
                            </div>
                            <div className="bg-white bg-opacity-20 rounded-lg p-4">
                                <div className="text-2xl font-bold text-white">{totalStoryPoints}</div>
                                <div className="text-sm text-white opacity-90">Story Points</div>
                            </div>
                            <div className="bg-white bg-opacity-20 rounded-lg p-4">
                                <div className="text-2xl font-bold text-white">{sprintCompletionRate}%</div>
                                <div className="text-sm text-white opacity-90">Completion Rate</div>
                            </div>
                            <div className="bg-white bg-opacity-20 rounded-lg p-4">
                                <div className="text-2xl font-bold text-white">{avgCommitsPerDev}</div>
                                <div className="text-sm text-white opacity-90">Avg Commits/Dev</div>
                            </div>
                        </div>
                    </div>
                    
                    {/* Individual Developer KPIs */}
                    <div className="space-y-4">
                        {developers
                            .sort((a, b) => (b.story_points_closed_in_sprint || 0) - (a.story_points_closed_in_sprint || 0))
                            .map((developer, index) => (
                                <DeveloperKPIRow 
                                    key={`${sprintKey}-${developer.name}`} 
                                    developer={developer} 
                                    sprintName={sprintInfo.name}
                                />
                            ))
                        }
                    </div>
                </div>
            );
        };

        const KPILegend = () => (
            <div className="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                <h3 className="text-lg font-semibold text-gray-900 mb-4">KPI Scoring Guide</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div>
                        <h4 className="font-medium text-gray-700 mb-2">ðŸŸ¢ Productivity (Commits)</h4>
                        <ul className="text-sm text-gray-600 space-y-1">
                            <li>Excellent: 15+ commits</li>
                            <li>Good: 10-14 commits</li>
                            <li>Fair: 5-9 commits</li>
                            <li>Needs Improvement: &lt;5 commits</li>
                        </ul>
                    </div>
                    <div>
                        <h4 className="font-medium text-gray-700 mb-2">ðŸ”µ Completion Rate (%)</h4>
                        <ul className="text-sm text-gray-600 space-y-1">
                            <li>Excellent: 80%+ completed</li>
                            <li>Good: 60-79% completed</li>
                            <li>Fair: 40-59% completed</li>
                            <li>Needs Improvement: &lt;40%</li>
                        </ul>
                    </div>
                    <div>
                        <h4 className="font-medium text-gray-700 mb-2">ðŸŸ¡ Velocity (Story Points)</h4>
                        <ul className="text-sm text-gray-600 space-y-1">
                            <li>Excellent: 10+ points</li>
                            <li>Good: 5-9 points</li>
                            <li>Fair: 2-4 points</li>
                            <li>Needs Improvement: 1 point</li>
                        </ul>
                    </div>
                    <div>
                        <h4 className="font-medium text-gray-700 mb-2">ðŸ”´ Efficiency (Points/Commit)</h4>
                        <ul className="text-sm text-gray-600 space-y-1">
                            <li>Excellent: 1.0+ pts/commit</li>
                            <li>Good: 0.5-0.9 pts/commit</li>
                            <li>Fair: 0.2-0.4 pts/commit</li>
                            <li>Needs Improvement: &lt;0.2</li>
                        </ul>
                    </div>
                </div>
                <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                    <p className="text-sm text-blue-800">
                        <strong>Note:</strong> These KPIs provide a quick performance overview. Consider context like task complexity, 
                        team collaboration, and sprint goals when interpreting results. High efficiency (story points per commit) 
                        indicates focused, impactful work.
                    </p>
                </div>
            </div>
        );

        const TeamSprintKPIDashboard = () => {
            const [teamData, setTeamData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [selectedSprint, setSelectedSprint] = useState('all');

            useEffect(() => {
                // This will be replaced with embedded data in the generated HTML
                fetch('data/team_sprint_stats.json')
                    .then(response => response.json())
                    .then(data => {
                        setTeamData(data);
                        setLoading(false);
                    })
                    .catch(error => {
                        console.error('Error loading team data:', error);
                        setLoading(false);
                    });
            }, []);

            if (loading) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <div className="animate-spin rounded-full h-32 w-32 border-b-2 border-telus-purple mx-auto"></div>
                            <p className="mt-4 text-gray-600">Loading KPI dashboard...</p>
                        </div>
                    </div>
                );
            }

            if (!teamData || !teamData.sprint_analytics) {
                return (
                    <div className="min-h-screen bg-gray-50 flex items-center justify-center">
                        <div className="text-center">
                            <p className="text-gray-600">No sprint data available</p>
                        </div>
                    </div>
                );
            }

            const sprints = Object.entries(teamData.sprint_analytics);
            const filteredSprints = selectedSprint === 'all' ? sprints : sprints.filter(([key]) => key === selectedSprint);

            return (
                <div className="min-h-screen bg-gray-50">
                    {/* Header */}
                    <div className="bg-white shadow-sm border-b border-gray-200">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex items-center justify-between h-16">
                                <div className="flex items-center">
                                    <h1 className="text-2xl font-bold text-gray-900">Team Sprint KPI Dashboard</h1>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <select
                                        value={selectedSprint}
                                        onChange={(e) => setSelectedSprint(e.target.value)}
                                        className="border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-telus-purple focus:border-transparent"
                                    >
                                        <option value="all">All Sprints</option>
                                        {sprints.map(([key, data]) => (
                                            <option key={key} value={key}>
                                                {data.sprint_info.name}
                                            </option>
                                        ))}
                                    </select>
                                    <div className="text-sm text-gray-500">
                                        Generated: {new Date(teamData.generated_at).toLocaleString()}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Main Content */}
                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <KPILegend />
                        
                        {filteredSprints.length === 0 ? (
                            <div className="text-center py-12">
                                <p className="text-gray-500">No sprint data available for the selected filter.</p>
                            </div>
                        ) : (
                            filteredSprints.map(([sprintKey, sprintData]) => (
                                <SprintKPISection 
                                    key={sprintKey} 
                                    sprintKey={sprintKey} 
                                    sprintData={sprintData} 
                                />
                            ))
                        )}
                    </div>
                </div>
            );
        };

        // Render the dashboard
        ReactDOM.render(<TeamSprintKPIDashboard />, document.getElementById('root'));
    </script>
</body>
</html>
